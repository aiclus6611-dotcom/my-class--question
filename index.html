<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚æå•äº’å‹•ç‰†</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; color: #333; height: 100vh; overflow-y: auto; }
        
        /* ä¸€èˆ¬å®¹å™¨ (å­¸å“¡ç«¯ç”¨) */
        .container { max-width: 900px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        
        /* è¬›å¸«ç«¯å°ˆç”¨ä½ˆå±€ */
        .teacher-layout {
            display: grid;
            grid-template-columns: 350px 1fr; /* å·¦å´å›ºå®šå¯¬åº¦ï¼Œå³å´è‡ªé©æ‡‰ */
            gap: 30px;
            padding: 30px;
            height: calc(100vh - 80px); /* æ‰£åº•éƒ¨çš„ç©ºé–“ */
            box-sizing: border-box;
            align-items: start;
        }

        h1 { text-align: center; color: #444; margin-bottom: 20px; font-weight: 800; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 0.9rem; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 0.95rem; margin: 5px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: #1976d2; color: white; }
        .btn-danger { background: #ef5350; color: white; }
        .btn-success { background: #66bb6a; color: white; }
        .btn-outline { background: white; border: 1px solid #ccc; color: #555; }
        .btn-dark { background: #37474f; color: white; }
        .btn-toggle-on { background: #00897b; color: white; }
        .btn-toggle-off { background: #cfd8dc; color: #555; }

        /* è¼¸å…¥å€å¡Š */
        .input-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; position: sticky; top: 0; z-index: 10; border: 1px solid #e1e4e8; }
        .input-row { display: flex; gap: 10px; }
        .main-input { flex: 1; padding: 12px 15px; font-size: 1.1rem; border: 2px solid #eee; border-radius: 8px; outline: none; transition: 0.3s; }
        .main-input:focus { border-color: #1976d2; background: #fdfdfd; }
        
        /* æå•åˆ—è¡¨ */
        .q-list-container { overflow-y: auto; height: 100%; padding-right: 5px; } 
        .q-list { display: flex; flex-direction: column; gap: 15px; }
        .q-card { background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; gap: 15px; transition: all 0.3s ease; border-left: 5px solid transparent; }
        .q-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .q-card.is-mine { border-left-color: #1976d2; background: #fbfdff; }
        .q-card.is-editing { border: 2px dashed #1976d2; }

        /* å·¦å´æŒ‰è®šå€ - ä¿®æ”¹ç‚ºè—è‰²ç³» */
        .vote-section { display: flex; flex-direction: column; align-items: center; min-width: 50px; justify-content: center; }
        .vote-btn { 
            background: none; 
            border: 1px solid #eee; 
            border-radius: 8px; 
            width: 50px; 
            height: 55px; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            transition: 0.2s; 
            color: #90a4ae; /* é è¨­ç°è‰² */
            position: relative; 
        }
        /* Hover æ•ˆæœï¼šè®Šæ·ºè— */
        .vote-btn:hover { background: #e3f2fd; border-color: #90caf9; color: #1976d2; }
        /* Active (å·²æŒ‰è®š) æ•ˆæœï¼šè®Šæ·±è— */
        .vote-btn.active { background: #e3f2fd; border-color: #1976d2; color: #1976d2; }
        .vote-btn:disabled { opacity: 0.5; cursor: not-allowed; } 
        
        .vote-count { font-weight: bold; font-size: 1rem; margin-top: 2px; }
        
        /* SVG åœ–ç¤ºè¨­å®š */
        .vote-icon-svg { width: 24px; height: 24px; fill: currentColor; }

        /* å³å´å…§å®¹å€ */
        .content-section { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .q-text { font-size: 1.15rem; line-height: 1.5; color: #2c3e50; white-space: pre-wrap; word-break: break-all;}
        .q-meta { font-size: 0.85rem; color: #999; margin-top: 8px; display: flex; justify-content: space-between; align-items: center; }
        
        .actions { display: flex; gap: 10px; }
        .action-link { cursor: pointer; color: #1976d2; text-decoration: underline; background: none; border: none; padding: 0; font-size: 0.85rem; }
        .action-link.delete { color: #d32f2f; }

        /* --- è¬›å¸« QR Code å€ (å·¦å´) --- */
        .qr-display-panel { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            text-align: center; 
            position: sticky; 
            top: 20px;
        }
        .qr-img-large { width: 100%; max-width: 300px; height: auto; border-radius: 5px; border: 1px solid #eee; }
        .qr-placeholder { color: #999; padding: 50px 0; border: 2px dashed #ddd; border-radius: 10px; background: #fafafa; }

        /* --- è¬›å¸«åº•éƒ¨æ§åˆ¶å° (Bottom Sheet) --- */
        .bottom-control-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #263238;
            color: white;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .bottom-toggle-btn {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #263238;
            color: white;
            width: 60px;
            height: 30px;
            border-radius: 10px 10px 0 0;
            text-align: center;
            line-height: 30px;
            cursor: pointer;
            font-size: 0.8rem;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }

        .control-content {
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .bottom-control-bar.hidden { transform: translateY(100%); }
        .bottom-control-bar.hidden .bottom-toggle-btn { top: -30px; }

        .control-group { display: flex; align-items: center; gap: 10px; }
        .control-label { color: #cfd8dc; font-size: 0.9rem; margin-right: 5px; }
        .upload-wrapper { display: flex; flex-direction: column; }

        /* RWD */
        @media (max-width: 850px) {
            .teacher-layout { grid-template-columns: 1fr; padding: 10px; height: auto; }
            .qr-display-panel { position: static; margin-bottom: 20px; max-width: 250px; margin: 0 auto 20px auto; }
            .bottom-control-bar { padding-bottom: 20px; }
            .control-content { flex-direction: column; align-items: stretch; }
            .bottom-toggle-btn { width: 100px; }
        }

        .loading-mask { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(240,242,245,0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; font-size: 1.5rem; color: #666; }
    </style>
</head>
<body>
    <div id="app">
        
        <div v-if="isLoading" class="loading-mask">
            <div>è³‡æ–™è¼‰å…¥ä¸­...</div>
        </div>

        <div v-if="!isTeacher" class="container">
            <h1>å­¸å“¡æå•äº’å‹•å€</h1>
            <div class="subtitle">å³æ™‚åŒæ­¥ â€¢ åŒ¿åæå• â€¢ äº’å‹•æŒ‰è®š</div>
            
            <div class="input-card">
                <div class="input-row">
                    <input type="text" class="main-input" v-model="newQuestionText" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œæˆ–æƒ³æ³•..." @keydown.enter="submitQuestion">
                    <button class="btn btn-primary" @click="submitQuestion" :disabled="!newQuestionText.trim()">é€å‡º</button>
                </div>
            </div>

            <div class="q-list">
                <transition-group name="list">
                    <div v-for="q in sortedQuestions" :key="q.id" class="q-card" :class="{ 'is-mine': isMyQuestion(q) }">
                        <div class="vote-section">
                            <button class="vote-btn" :class="{ 'active': hasLiked(q.id) }" @click="toggleLike(q)" :disabled="processingLikes[q.id]">
                                <svg class="vote-icon-svg" viewBox="0 0 24 24">
                                    <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.01-.01L23 10z"/>
                                </svg>
                                <span class="vote-count">{{ q.likes || 0 }}</span>
                            </button>
                        </div>
                        <div class="content-section">
                            <div v-if="editingId !== q.id">
                                <div class="q-text">{{ q.text }}</div>
                                <div class="q-meta">
                                    <span v-if="showTimeSetting">{{ formatTime(q.timestamp) }}</span>
                                    
                                    <div class="actions">
                                        <span v-if="canEdit(q)" class="action-link" @click="startEdit(q)">ç·¨è¼¯</span>
                                        <span v-if="canDelete(q)" class="action-link delete" @click="deleteQuestion(q.id)">åˆªé™¤</span>
                                    </div>
                                </div>
                            </div>
                            <div v-else>
                                <input type="text" v-model="editingText" class="main-input" style="width: 95%; margin-bottom: 10px;" ref="editInput" @keydown.enter="saveEdit(q.id)">
                                <div class="actions">
                                    <button class="btn btn-success btn-sm" @click="saveEdit(q.id)">å„²å­˜</button>
                                    <button class="btn btn-outline btn-sm" @click="cancelEdit">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition-group>
                <div v-if="sortedQuestions.length === 0" style="text-align: center; color: #999; padding: 40px;">ç›®å‰é‚„æ²’æœ‰äººæå•ï¼Œæˆç‚ºç¬¬ä¸€å€‹ç™¼å•çš„äººå§ï¼</div>
            </div>
        </div>

        <div v-if="isTeacher" class="teacher-layout">
            
            <div class="qr-display-panel">
                <h3 style="margin-top:0; color:#444;">æƒæåŠ å…¥æå•</h3>
                <div v-if="qrCodeUrl">
                    <img :src="qrCodeUrl" class="qr-img-large" alt="QR Code">
                </div>
                <div v-else class="qr-placeholder">
                    å°šç„¡ QR Code<br>
                    <span style="font-size:0.8rem">è«‹è‡³ä¸‹æ–¹åŠŸèƒ½å€ä¸Šå‚³</span>
                </div>
            </div>

            <div class="q-list-container">
                <div class="q-list">
                    <transition-group name="list">
                        <div v-for="q in sortedQuestions" :key="q.id" class="q-card" :class="{ 'is-editing': editingId === q.id }">
                            <div class="vote-section">
                                <div style="font-weight:bold; color:#1976d2; font-size:1.2rem;">{{ q.likes || 0 }}</div>
                                <div style="font-size:0.8rem; color:#888;">æŒ‰è®š</div>
                            </div>
                            <div class="content-section">
                                <div v-if="editingId !== q.id">
                                    <div class="q-text">{{ q.text }}</div>
                                    <div class="q-meta">
                                        <span v-if="showTimeSetting">{{ formatTime(q.timestamp) }}</span>

                                        <div class="actions">
                                            <span class="action-link" @click="startEdit(q)">ç·¨è¼¯</span>
                                            <span class="action-link delete" @click="deleteQuestion(q.id)">åˆªé™¤</span>
                                        </div>
                                    </div>
                                </div>
                                <div v-else>
                                    <input type="text" v-model="editingText" class="main-input" style="width: 95%; margin-bottom: 10px;" ref="editInput" @keydown.enter="saveEdit(q.id)">
                                    <div class="actions">
                                        <button class="btn btn-success btn-sm" @click="saveEdit(q.id)">å„²å­˜</button>
                                        <button class="btn btn-outline btn-sm" @click="cancelEdit">å–æ¶ˆ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </transition-group>
                    <div v-if="sortedQuestions.length === 0" style="text-align: center; color: #999; padding: 40px;">ç›®å‰å°šç„¡æå•</div>
                </div>
            </div>
        </div>

        <div v-if="isTeacher" class="bottom-control-bar" :class="{ 'hidden': !showControls }">
            <div class="bottom-toggle-btn" @click="showControls = !showControls">
                {{ showControls ? 'â–¼ éš±è—' : 'â–² è¨­å®š' }}
            </div>
            
            <div class="control-content">
                <div class="control-group">
                    <span class="control-label">æ’åºï¼š</span>
                    <button class="btn" :class="sortBy === 'likes' ? 'btn-primary' : 'btn-dark'" @click="sortBy = 'likes'">
                        ğŸ‘ ç†±é–€
                    </button>
                    <button class="btn" :class="sortBy === 'time' ? 'btn-primary' : 'btn-dark'" @click="sortBy = 'time'">
                        ğŸ•’ æ™‚é–“
                    </button>
                </div>

                <div class="control-group">
                    <span class="control-label">æå•æ™‚é–“ï¼š</span>
                    <button class="btn" :class="showTimeSetting ? 'btn-toggle-on' : 'btn-toggle-off'" @click="toggleTimeSetting">
                        {{ showTimeSetting ? 'ğŸ‘ï¸ é¡¯ç¤ºä¸­' : 'ğŸ™ˆ å·²éš±è—' }}
                    </button>
                </div>

                <div class="control-group upload-wrapper">
                    <span class="control-label">æ›´æ› QR Codeï¼š</span>
                    <input type="file" accept="image/*" @change="handleQrUpload" style="color: white; font-size: 0.9rem;">
                </div>

                <div class="control-group">
                    <button class="btn btn-danger" @click="clearAllData">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å•é¡Œ
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue;

        const firebaseConfig = {
            apiKey: "AIzaSyDUPGhkiJgxeYDYHqEaXCYvKh2vdTGqypw",
            authDomain: "class-discussion-01.firebaseapp.com",
            databaseURL: "https://class-discussion-01-default-rtdb.firebaseio.com",
            projectId: "class-discussion-01",
            storageBucket: "class-discussion-01.firebasestorage.app",
            messagingSenderId: "724687365020",
            appId: "1:724687365020:web:380b5d85872dc2d9b85e59",
            measurementId: "G-XYN5JV48T7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        createApp({
            data() {
                return {
                    isLoading: true,
                    isTeacher: false,
                    showControls: true, 
                    
                    questions: [],
                    newQuestionText: '',
                    
                    editingId: null,
                    editingText: '',

                    myAuthorId: '',
                    myLikedIds: [],
                    processingLikes: {}, 
                    
                    sortBy: 'likes', 
                    qrCodeUrl: '',
                    
                    showTimeSetting: true 
                }
            },
            computed: {
                sortedQuestions() {
                    let list = [...this.questions];
                    if (this.sortBy === 'likes') {
                        list.sort((a, b) => {
                            const likesA = a.likes || 0;
                            const likesB = b.likes || 0;
                            if (likesA !== likesB) return likesB - likesA;
                            return b.timestamp - a.timestamp;
                        });
                    } else {
                        list.sort((a, b) => b.timestamp - a.timestamp);
                    }
                    return list;
                }
            },
            mounted() {
                let storedId = localStorage.getItem('qa_author_id');
                if (!storedId) {
                    storedId = 'user_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                    localStorage.setItem('qa_author_id', storedId);
                }
                this.myAuthorId = storedId;

                const storedLikes = localStorage.getItem('qa_liked_ids');
                if (storedLikes) {
                    this.myLikedIds = JSON.parse(storedLikes);
                }

                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('role') === 'teacher') {
                    this.isTeacher = true;
                } else {
                    this.sortBy = 'time';
                }

                db.ref('qa_system/questions').on('value', snapshot => {
                    const val = snapshot.val();
                    this.isLoading = false;
                    if (val) {
                        this.questions = Object.keys(val).map(key => ({
                            id: key,
                            ...val[key]
                        }));
                    } else {
                        this.questions = [];
                    }
                });

                db.ref('qa_system/settings').on('value', snapshot => {
                    const settings = snapshot.val() || {};
                    if (settings.qrCode) {
                        this.qrCodeUrl = settings.qrCode;
                    }
                    if (settings.showTime !== undefined) {
                        this.showTimeSetting = settings.showTime;
                    } else {
                        this.showTimeSetting = true; 
                    }
                });
            },
            methods: {
                submitQuestion() {
                    const text = this.newQuestionText.trim();
                    if (!text) return;

                    const newRef = db.ref('qa_system/questions').push();
                    newRef.set({
                        text: text,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        likes: 0,
                        authorId: this.myAuthorId
                    }).then(() => {
                        this.newQuestionText = '';
                    });
                },
                canEdit(q) { return this.isTeacher || q.authorId === this.myAuthorId; },
                canDelete(q) { return this.isTeacher || q.authorId === this.myAuthorId; },
                isMyQuestion(q) { return q.authorId === this.myAuthorId; },
                startEdit(q) {
                    this.editingId = q.id;
                    this.editingText = q.text;
                    this.$nextTick(() => { if(this.$refs.editInput && this.$refs.editInput[0]) this.$refs.editInput[0].focus(); });
                },
                cancelEdit() { this.editingId = null; this.editingText = ''; },
                saveEdit(id) {
                    if (!this.editingText.trim()) return;
                    db.ref('qa_system/questions/' + id).update({ text: this.editingText }).then(() => { this.editingId = null; });
                },
                deleteQuestion(id) {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å•é¡Œå—ï¼Ÿ')) {
                        db.ref('qa_system/questions/' + id).remove();
                    }
                },
                
                hasLiked(id) { return this.myLikedIds.includes(id); },
                toggleLike(q) {
                    const id = q.id;
                    if (this.processingLikes[id]) return;
                    this.processingLikes[id] = true;

                    const isLiked = this.hasLiked(id);
                    const ref = db.ref('qa_system/questions/' + id + '/likes');
                    
                    ref.transaction((currentLikes) => {
                        const val = currentLikes || 0;
                        if (isLiked) {
                            return val > 0 ? val - 1 : 0;
                        } else {
                            return val + 1;
                        }
                    }).then(() => {
                        if (isLiked) {
                            this.myLikedIds = this.myLikedIds.filter(lid => lid !== id);
                        } else {
                            this.myLikedIds.push(id);
                        }
                        localStorage.setItem('qa_liked_ids', JSON.stringify(this.myLikedIds));
                        this.processingLikes[id] = false;
                    }).catch(() => {
                        this.processingLikes[id] = false;
                    });
                },

                toggleTimeSetting() {
                    db.ref('qa_system/settings/showTime').set(!this.showTimeSetting);
                },
                clearAllData() {
                    if (confirm('è­¦å‘Šï¼šé€™å°‡æœƒæ¸…ç©ºæ‰€æœ‰å­¸å“¡çš„æå•ï¼ç¢ºå®šåŸ·è¡Œå—ï¼Ÿ')) {
                        db.ref('qa_system/questions').remove();
                    }
                },
                handleQrUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    if (file.size > 500 * 1024) { alert('åœ–ç‰‡å¤ªå¤§ï¼Œè«‹ä½¿ç”¨å°æ–¼ 500KB çš„åœ–ç‰‡'); return; }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        db.ref('qa_system/settings/qrCode').set(e.target.result);
                    };
                    reader.readAsDataURL(file);
                },
                formatTime(ts) {
                    if (!ts) return '';
                    const date = new Date(ts);
                    return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>